<!DOCTYPE html>
<html>
<head>
  <title>Shop SIM - Onion</title>
  <link rel="stylesheet" href="stile.css">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="disable-screenshot" content="true">
  <meta charset="UTF-8">
  <!-- Removed intrusive screenshot/contextmenu/blocking script per request -->
  <style>
    /* Stili originali di sim.html adattati */
    .sim-shop {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    .header-section {
      text-align: center;
      margin-bottom: 30px;
    }
    .header-section h1 {
      color: #229ED9;
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    .header-section p {
      font-size: 1.1em;
      color: #666;
      max-width: 600px;
      margin: 0 auto;
    }
    .warning-box {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      text-align: center;
    }
    .warning-box strong {
      color: #856404;
    }
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }
    .product-card {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
    }
    .product-card:hover {
      border-color: #229ED9;
      box-shadow: 0 4px 12px rgba(34,158,217,0.2);
      transform: translateY(-2px);
    }
    .product-card.selected {
      border-color: #28a745;
      background: #f8fff9;
    }
    .product-card.out-of-stock {
      border-color: #dc3545;
      background: #fff5f5;
    }
    .product-name {
      font-size: 1.3em;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }
    .product-price {
      font-size: 1.8em;
      color: #229ED9;
      font-weight: bold;
      margin: 15px 0;
    }
    .product-stock {
      color: #666;
      font-size: 0.9em;
      margin-bottom: 15px;
    }
    .product-stock.out {
      color: #dc3545;
      font-weight: 700;
    }
    .select-btn {
      background: #229ED9;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
      transition: background 0.3s ease;
    }
    .select-btn:hover {
      background: #1a7ab8;
    }
    .select-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      opacity: 0.9;
    }
    .selected .select-btn {
      background: #28a745;
    }
    .selected .select-btn:hover {
      background: #218838;
    }
    .order-section {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-top: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .order-section h2 {
      color: #333;
      text-align: center;
      margin-bottom: 25px;
    }
    .form-row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .form-group {
      flex: 1;
    }
    .form-group.full-width {
      flex: none;
      width: 100%;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
    }
    input, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 1em;
      transition: border-color 0.3s ease;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: #229ED9;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    .order-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.2em;
      font-weight: bold;
      width: 100%;
      margin-top: 20px;
      transition: background 0.3s ease;
    }
    .order-btn:hover {
      background: #218838;
    }
    .order-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .message {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #229ED9;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @media (max-width: 768px) {
      .form-row {
        flex-direction: column;
        gap: 0;
      }
      .product-grid {
        grid-template-columns: 1fr;
      }
    }
    /* Stili dal nuovo design */
    .cart-icon {
      position: fixed;
      top: 20px;
      right: 20px;
      cursor: pointer;
      z-index: 1000;
    }
    .cart-badge {
      position: absolute;
      top: -10px;
      right: -10px;
      background: #ff0000;
      color: white;
      border-radius: 50%;
      padding: 5px 8px;
      font-size: 0.8em;
      font-weight: bold;
    }
    .cart-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .cart-modal-content {
      background-color: #fff;
      margin: 8% auto;
      padding: 20px;
      border-radius: 12px;
      width: 92%;
      max-width: 560px;
      box-shadow: 0 14px 48px rgba(2,6,23,0.12);
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: black;
    }
    .menu-rotella {
      position: fixed;
      right: 24px;
      bottom: 24px;
      background: #fff;
      border-radius: 50px;
      box-shadow: 0 2px 12px #0002;
      padding: 10px 24px;
      z-index: 1000;
      border: 1px solid #eee;
    }
    .menu-rotella ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      gap: 18px;
    }
    .menu-rotella a {
      color: #222;
      text-decoration: none;
      font-weight: 500;
      font-size: 1.1em;
      transition: color 0.2s;
    }
    .menu-rotella a:hover {
      color: #0055cc;
    }
    .prezzo-prodotto {
      font-size: 1.2em !important;
      font-weight: bold;
      color: #0055cc;
    }

    /* THEME */
    :root{
      --bg-1: linear-gradient(135deg,#f3f8ff 0%,#eef7f3 100%);
      --primary: #0055cc;
      --accent: #28a745;
      --muted: #6c757d;
      --danger: #dc3545;
      --card-shadow: 0 10px 30px rgba(2,6,23,0.08);
    }
    html,body{height:100%;}
    body{
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg-1);
      color: #222;
      -webkit-font-smoothing:antialiased;
      padding-bottom: 80px;
    }
    .container{max-width:980px;margin:0 auto;padding:28px;}

    /* Product card modern look */
    .product-card{border:none;border-radius:14px;box-shadow:var(--card-shadow);overflow:hidden;display:flex;flex-direction:column;justify-content:space-between;min-height:220px}
    .product-image{height:140px;background:linear-gradient(180deg,#fff 0%,#f0f6ff 100%);display:flex;align-items:center;justify-content:center}
    .product-image svg{width:72px;height:72px;opacity:0.95}
    .price-badge{position:absolute;right:12px;top:12px;background:#fff;padding:8px 12px;border-radius:20px;font-weight:700;color:var(--primary);box-shadow:0 6px 18px rgba(0,85,204,0.08)}
    .soldout-badge{position:absolute;left:12px;top:12px;background:var(--danger);color:#fff;padding:6px 10px;border-radius:12px;font-weight:700}
    .product-card .product-name{margin-top:10px}

    /* nicer controls */
    .product-controls{margin-top:12px}

    /* Toast */
    .toast-container{position:fixed;right:20px;top:20px;z-index:2500}
    .toast{margin-bottom:8px;padding:10px 14px;border-radius:8px;color:#fff;box-shadow:0 8px 24px rgba(2,6,23,0.08);opacity:0;transform:translateY(-8px);transition:all .25s}
    .toast.show{opacity:1;transform:translateY(0)}
    .toast.info{background:var(--primary)}
    .toast.success{background:var(--accent)}
    .toast.error{background:var(--danger)}

    /* cart badge pulse */
    .cart-badge.pulse{transform:scale(1.35);transition:transform .18s}

    .warning-box{background:#fffdf5;border-color:#fff0c2}
    .primary-cta{background:linear-gradient(90deg,var(--primary),#007bff);color:#fff;padding:14px 32px;border-radius:40px;border:none;box-shadow:0 10px 30px rgba(0,85,204,0.15);font-size:1.05em;font-weight:700;cursor:pointer}
    .primary-cta:hover{transform:translateY(-3px)}
    h1{font-size:2.6em;color:var(--primary);margin-bottom:6px}

    .hero{background:linear-gradient(90deg,rgba(0,85,204,0.06),rgba(40,167,69,0.04));border-radius:12px;padding:18px;margin-bottom:18px;box-shadow:0 6px 18px rgba(2,6,23,0.04)}
  </style>
</head>
<body>
  <div class="cart-icon" onclick="toggleCart()">
    <span class="cart-badge" id="cart-badge">0</span>
    <svg width="32" height="32" viewBox="0 0 24 24"><path fill="#0055cc" d="M7 20q-.825 0-1.413-.588T5 18q0-.825.588-1.413T7 16q.825 0 1.413.588T9 18q0 .825-.588 1.413T7 20Zm10 0q-.825 0-1.413-.588T15 18q0-.825.588-1.413T17 16q.825 0 1.413.588T19 18q0 .825-.588 1.413T17 20ZM6.2 6l2.6 5.5h6.65q.125 0 .225-.063t.15-.162l3.15-5.725q.125-.225-.013-.437T18.6 5H7.1l-.45-.9Q6.5 3.75 6.263 3.625T5.8 3.5H3v1.5h2l3.6 7.6-1.35 2.45q-.275.5-.038 1.025T8.7 16h10v-1.5H9.425q-.05 0-.088-.038T9.3 14.4l.9-1.6h6.45q.425 0 .763-.225t.487-.6l3.15-5.725q.125-.225-.013-.437T18.6 5H7.1l-.45-.9Q6.5 3.75 6.263 3.625T5.8 3.5H3v1.5h2l3.6 7.6-1.35 2.45q-.275.5-.038 1.025T8.7 16h10v-1.5H9.425q-.05 0-.088-.038T9.3 14.4l.9-1.6h6.45q.425 0 .763-.225t.487-.6l3.15-5.725q.125-.225-.013-.437T18.6 5H7.1l-.45-.9Q6.5 3.75 6.263 3.625T5.8 3.5H3v1.5h2Z"/></svg>
  </div>
  <div id="toast" class="toast-container" aria-live="polite"></div>
  <h1 style="text-align:center;">üõí Acquista SIM Anonima</h1>
  <div class="container" style="margin-top:32px;">
    <div class="header-section hero">
      <p>SIM prepagata completamente anonima. Zero registrazione, consegna rapida in Italia. Pagamento in TON crypto.</p>
    </div>

    <div class="warning-box">
      <strong>‚úÖ Accesso diretto disponibile:</strong> Ora puoi comprare SIM senza essere connesso a Yggdrasil! Per massima privacy, puoi ancora usare Yggdrasil seguendo la guida qui sotto.
    </div>

    <div id="prodotti-list" class="product-grid" style="margin-top: 24px; gap: 24px;">
      <!-- I prodotti verranno caricati dinamicamente -->
    </div>
  </div>
  <div id="cart-modal" class="cart-modal" style="display:none;">
    <div class="cart-modal-content">
      <span class="close" onclick="toggleCart()">&times;</span>
      <h2>Il tuo carrello</h2>
      <div id="cart-list"></div>
      <div id="cart-total" style="margin-top:12px;font-weight:bold;"></div>
      <div style="margin-top:8px;">
        <button type="button" id="copy-curl-btn" class="copy-curl" onclick="copyCurlToClipboard()" disabled>Copia comando CURL</button>
        <button type="button" onclick="clearCart()" style="margin-left:8px;padding:8px 12px;border-radius:6px;border:none;cursor:pointer;">Svuota carrello</button>
      </div>
      <div id="cart-msg" style="display:none; color:green; margin-top:12px; font-weight:bold;"></div>
      <div style="margin-top:18px;">
        <input type="text" id="user_contatto" placeholder="üì± ID Telegram (numerico)" style="width:90%;margin-bottom:8px;"><br>
        <small style="color:#666;">üí° Per ottenere il tuo ID Telegram: scrivi a @userinfobot su Telegram</small><br>
        <input type="text" id="user_nome" placeholder="üë§ Nome (opzionale)" style="width:90%;margin-bottom:8px;"><br>
        <input type="text" id="indirizzo" placeholder="üè† Indirizzo di consegna" style="width:90%;margin-bottom:8px;"><br>
        <input type="text" id="citofono" placeholder="üö™ Citofono/Interno" style="width:90%;margin-bottom:8px;"><br>
        <input type="text" id="note" placeholder="üìù Note aggiuntive" style="width:90%;margin-bottom:8px;"><br>
        <button type="button" id="checkout-btn" onclick="checkout()">Conferma ordine</button>
      </div>
      <div id="ordine-ok" style="display:none; color:green; margin-top:12px; font-weight:bold;"></div>
    </div>
  </div>
  <div style="text-align:center; margin-top:32px;">
    <button type="button" onclick="toggleCart()" class="primary-cta">
      Vai al carrello e concludi ordine
    </button>
  </div>
  <div id="ygg-guide" style="margin-top: 40px; padding-top: 40px; border-top: 2px solid #e0e0e0; text-align: center;">
    <h2>üåê Guida Yggdrasil - Accesso Ultra-Sicuro (Opzionale)</h2>
    <div class="warning-box">
      <strong>üîí Per massima privacy:</strong> Connettiti a Yggdrasil per un livello extra di anonimato. Non obbligatorio, ma raccomandato per acquisti ultra-sensibili.
    </div>
    <p>Segui la guida per installare Yggdrasil e connetterti al nostro nodo sicuro.</p>
    <a href="https://yggdrasil-network.github.io/" target="_blank" style="background: #229ED9; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; display: inline-block;">üì• Scarica Yggdrasil</a>
  </div>
  <nav class="menu-rotella">
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="sim.html">Shop SIM</a></li>
    </ul>
  </nav>
  <script>
    const API_BASE = '/ygg';

    let cart = [];
    let selectedProduct = null;

    // Carica prodotti
    async function loadProducts() {
      try {
        const response = await fetch(`${API_BASE}/api_magazzino/prodotti`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const products = await response.json();

        const productList = document.getElementById('prodotti-list');
        productList.innerHTML = '';

        // Debug area (shows raw JSON when troubleshooting)
        let debugContainer = document.getElementById('products-debug');
        if (!debugContainer) {
          debugContainer = document.createElement('div');
          debugContainer.id = 'products-debug';
          debugContainer.innerHTML = `<button class="debug-toggle" onclick="(function(el){el.style.display=(el.style.display==='none'?'block':'none')})(document.getElementById('products-debug-json'))">Mostra dati prodotti (debug)</button> <span id="products-debug-time" style="color:#666;font-size:0.95em;margin-left:8px;">(aggiornamento: --)</span><div id="products-debug-json" class="debug-json" style="display:none"></div>`;
          productList.parentNode.appendChild(debugContainer);
        }
        const debugJson = document.getElementById('products-debug-json');
        debugJson.textContent = JSON.stringify(products, null, 2);
        debugJson.style.display = 'none';
        const dt = new Date();
        const tspan = document.getElementById('products-debug-time');
        if (tspan) tspan.textContent = `(aggiornamento: ${dt.toLocaleString()})`;

        if (products.length === 0) {
          productList.innerHTML = '<div class="product-card"><p>Nessun prodotto disponibile al momento.</p></div>';
          return;
        }

        products.forEach(product => {
          // Support different field names from backend: prefer quantita, poi disp
          let available = Number(product.quantita ?? product.disp ?? product.available ?? 0);
          if (isNaN(available)) available = 0;

          const card = document.createElement('div');
          card.className = 'product-card';
          card.dataset.id = product.id;
          card.dataset.available = available;
          card.style.position = 'relative';

          // image / artwork
          const imgDiv = document.createElement('div');
          imgDiv.className = 'product-image';
          imgDiv.innerHTML = `
            <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <rect x="6" y="10" width="52" height="36" rx="4" fill="#e9f3ff" stroke="#cfe6ff" />
              <rect x="12" y="18" width="40" height="20" rx="2" fill="#fff" />
              <g transform="translate(12,18)">
                <rect x="2" y="2" width="12" height="6" rx="1" fill="#0055cc" />
                <rect x="16" y="2" width="18" height="6" rx="1" fill="#007bff" />
              </g>
            </svg>
          `;
          const priceBadge = document.createElement('div');
          priceBadge.className = 'price-badge';
          priceBadge.textContent = `‚Ç¨${(typeof product.prezzo !== 'undefined') ? product.prezzo : 'N/A'}`;
          card.appendChild(imgDiv);
          card.appendChild(priceBadge);

          const nameDiv = document.createElement('div');
          nameDiv.className = 'product-name';
          nameDiv.textContent = product.nome || 'SIM Anonima';

          const stockDiv = document.createElement('div');
          stockDiv.className = 'product-stock';
          stockDiv.textContent = `Disponibili: ${available}`;
          if (available <= 0) {
            card.classList.add('out-of-stock');
            stockDiv.classList.add('out');
            const s = document.createElement('div');
            s.className = 'soldout-badge';
            s.textContent = 'Esaurito';
            card.appendChild(s);
          }

          // controls: quantity + add to cart
          const controlsDiv = document.createElement('div');
          controlsDiv.className = 'product-controls';

          const qtyInput = document.createElement('input');
          qtyInput.type = 'number';
          qtyInput.min = 1;
          qtyInput.max = available;
          qtyInput.value = available > 0 ? 1 : 0;
          qtyInput.className = 'quantity-input';
          qtyInput.addEventListener('input', () => {
            let v = parseInt(qtyInput.value) || 0;
            if (v < 1) v = 1;
            if (v > available) v = available;
            qtyInput.value = v;
          });

          const addBtn = document.createElement('button');
          addBtn.type = 'button';
          addBtn.className = 'add-btn';
          addBtn.textContent = available > 0 ? 'Aggiungi al carrello' : 'Esaurito';
          addBtn.disabled = available <= 0;
          addBtn.addEventListener('click', () => {
            const q = Number(qtyInput.value) || 1;
            addToCart(product.id, product.nome, product.prezzo, q, available, product.magazzino);
          });

          controlsDiv.appendChild(qtyInput);
          controlsDiv.appendChild(addBtn);

          card.appendChild(nameDiv);
          card.appendChild(stockDiv);
          card.appendChild(controlsDiv);

          productList.appendChild(card);
        });
        // Sync cart UI state
        updateCartDisplay();
       } catch (error) {
        console.error('Errore caricamento prodotti:', error);
        document.getElementById('prodotti-list').innerHTML = `
          <div class="product-card">
            <div class="message error">
              ‚ùå Errore caricamento prodotti. Riprova tra qualche istante o contatta il supporto.<br>
              <small>Dettagli: ${error.message}</small>
            </div>
          </div>
        `;
      }
    }

    function addToCart(id, nome, prezzo, qty, available, magazzino) {
      qty = Number(qty) || 1;
      if (qty <= 0) { showToast('Inserisci una quantit√† valida.','error'); return; }

      // Ensure we don't take more than what's currently available on the card
      const card = document.querySelector(`.product-card[data-id="${id}"]`);
      const currentAvail = card ? Number(card.dataset.available || available || 0) : (available || 0);
      if (qty > currentAvail) { showToast('Quantit√† superiore alla disponibilit√†.','error'); return; }

      const existing = cart.find(item => item.id === id);
      if (existing) {
        existing.qty = existing.qty + qty;
      } else {
        cart.push({ id, nome, prezzo, qty, available: available || 0, magazzino: magazzino || 1 });
      }
      // decrease shown availability on the card
      if (card) {
        const newAvail = Math.max(0, (Number(card.dataset.available || available || 0) - qty));
        card.dataset.available = newAvail;
        const stockDiv = card.querySelector('.product-stock');
        if (stockDiv) stockDiv.textContent = `Disponibili: ${newAvail}`;
        const qinput = card.querySelector('.quantity-input'); if (qinput) { qinput.max = newAvail; if (Number(qinput.value) > newAvail) qinput.value = newAvail; }
        const addB = card.querySelector('.add-btn'); if (addB && newAvail <= 0) { addB.disabled = true; card.classList.add('out-of-stock'); stockDiv.classList.add('out'); }
      }
      updateCartBadge();
      updateCartDisplay();
      showCartMessage(`${qty} √ó ${nome} aggiunto${qty>1?'i':''} al carrello.`);
      showToast(`${qty} √ó ${nome} aggiunto${qty>1?'i':''} al carrello.`,'success');
      pulseCart();
    }

    function changeCartQty(id, delta) {
      const item = cart.find(it => it.id === id);
      if (!item) return;
      const card = document.querySelector(`.product-card[data-id="${id}"]`);
      let cardAvail = card ? Number(card.dataset.available || 0) : 0;
      if (delta > 0) {
        // increase quantity if available
        const inc = Math.min(delta, cardAvail || 0);
        if (inc <= 0) { showCartMessage('Nessun altro pezzo disponibile'); return; }
        item.qty += inc;
        if (card) { card.dataset.available = cardAvail - inc; cardAvail = card.dataset.available; card.querySelector('.product-stock').textContent = `Disponibili: ${cardAvail}`; }
      } else if (delta < 0) {
        // decrease quantity and restore availability
        const dec = Math.min(-delta, item.qty - 1);
        if (dec <= 0) return;
        item.qty -= dec;
        if (card) { card.dataset.available = Number(card.dataset.available || 0) + dec; card.querySelector('.product-stock').textContent = `Disponibili: ${card.dataset.available}`; card.querySelector('.add-btn').disabled = false; card.classList.remove('out-of-stock'); }
      }
      updateCartDisplay();
      updateCartBadge();
    }

    function removeCartItem(id) {
      const item = cart.find(it => it.id === id);
      if (!item) return;
      // restore availability on card
      const card = document.querySelector(`.product-card[data-id="${id}"]`);
      if (card) { card.dataset.available = Number(card.dataset.available || 0) + item.qty; const stockDiv = card.querySelector('.product-stock'); if (stockDiv) stockDiv.textContent = `Disponibili: ${card.dataset.available}`; card.querySelector('.add-btn').disabled = false; card.classList.remove('out-of-stock'); }
      cart = cart.filter(it => it.id !== id);
      updateCartDisplay();
      updateCartBadge();
    }

    function clearCart() {
      cart = [];
      updateCartDisplay();
      updateCartBadge();
    }

    function showCartMessage(msg) {
      const el = document.getElementById('cart-msg');
      if (!el) return;
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; el.textContent = ''; }, 3000);
    }

    function showToast(msg, type = 'info') {
      const container = document.getElementById('toast');
      if (!container) return;
      const el = document.createElement('div');
      el.className = `toast ${type}`;
      el.textContent = msg;
      container.appendChild(el);
      // show
      setTimeout(() => el.classList.add('show'), 10);
      // remove
      setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 300); }, 3600);
    }

    function pulseCart() {
      const badge = document.getElementById('cart-badge');
      if (!badge) return;
      badge.classList.add('pulse');
      setTimeout(() => badge.classList.remove('pulse'), 400);
    }

    // Toggle/Open/Close cart modal
    function openCart() {
      const modal = document.getElementById('cart-modal');
      if (!modal) return;
      updateCartDisplay();
      modal.style.display = 'block';
      modal.classList.add('open');
      document.body.style.overflow = 'hidden';
      // set focus to first input
      const firstInput = modal.querySelector('input');
      if (firstInput) firstInput.focus();
    }

    function closeCart() {
      const modal = document.getElementById('cart-modal');
      if (!modal) return;
      modal.style.display = 'none';
      modal.classList.remove('open');
      document.body.style.overflow = '';
    }

    function toggleCart(force) {
      const modal = document.getElementById('cart-modal');
      if (!modal) return;
      if (typeof force === 'boolean') {
        if (force) openCart(); else closeCart();
        return;
      }
      if (modal.style.display === 'block' || modal.classList.contains('open')) {
        closeCart();
      } else {
        openCart();
      }
    }

    // Click outside modal closes it
    document.addEventListener('click', function(e) {
      const modal = document.getElementById('cart-modal');
      if (!modal) return;
      if (modal.style.display === 'block' && e.target === modal) {
        closeCart();
      }
    });

    // ESC closes modal
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeCart();
    });

    // Aggiorna badge carrello (mostra quantit√† totale)
    function updateCartBadge() {
      const badge = document.getElementById('cart-badge');
      const totalQty = cart.reduce((sum, item) => sum + (item.qty || 0), 0);
      badge.textContent = totalQty;
    }

    // Aggiorna display carrello (lista con controlli)
    function updateCartDisplay() {
      const cartList = document.getElementById('cart-list');
      const cartTotal = document.getElementById('cart-total');
      const cartMsg = document.getElementById('cart-msg');

      if (cart.length === 0) {
        cartList.innerHTML = '<p class="empty-note">Il carrello √® vuoto.</p>';
        cartTotal.textContent = '';
        const copyBtn = document.getElementById('copy-curl-btn'); if (copyBtn) copyBtn.disabled = true;
        const checkoutBtn = document.getElementById('checkout-btn'); if (checkoutBtn) checkoutBtn.disabled = true;
        return;
      }

      cartList.innerHTML = cart.map(item => `
        <div class="cart-item">
          <div>
            <strong>${item.nome}</strong><br><small>‚Ç¨${item.prezzo} x ${item.qty}</small>
          </div>
          <div class="cart-actions">
            <button type="button" aria-label="Diminuisci quantit√†" onclick="changeCartQty(${item.id}, -1)">‚àí</button>
            <button type="button" aria-label="Aumenta quantit√†" onclick="changeCartQty(${item.id}, 1)" class="primary">+</button>
            <button type="button" aria-label="Rimuovi" onclick="removeCartItem(${item.id})">Rimuovi</button>
          </div>
        </div>
      `).join('');

      const total = cart.reduce((sum, item) => sum + (item.prezzo * item.qty), 0);
      cartTotal.textContent = `Totale: ‚Ç¨${total.toFixed(2)}`;

      const copyBtn = document.getElementById('copy-curl-btn'); if (copyBtn) copyBtn.disabled = false;
      const checkoutBtn = document.getElementById('checkout-btn'); if (checkoutBtn) checkoutBtn.disabled = false;
    }

    function generateCurlCommand() {
      const extKey = '4bba4221d47af247e69110d4d86335051ee13ea0795386341386f6af989f5ff2';
      const yggIp = '200:421e:6385:4a8b:dca7:cfb:197f:e9c3';
      const user_contatto = document.getElementById('user_contatto').value || 'IL_TUO_ID_TELEGRAM_NUMERICO';
      const user_nome = document.getElementById('user_nome').value || 'Il Tuo Nome';
      const indirizzo = document.getElementById('indirizzo').value || 'Via Roma 123, Roma';
      const citofono = document.getElementById('citofono').value || '';
      const order = {
        prodotti: cart.map(item => ({ id: item.id, nome: item.nome, qty: item.qty, magazzino: (item.magazzino||1) })),
        user_contatto, user_nome, indirizzo, citofono
      };
      const json = JSON.stringify(order);
      const cmd = `curl -6 --interface ygg0 \
  -H "X-API-KEY: ${extKey}" \
  -H "Content-Type: application/json" \
  -d '${json}' \
  "http://[${yggIp}]:8081/privato/ordina.py"`;
      return cmd;
    }

    async function copyCurlToClipboard() {
      const cmd = generateCurlCommand();
      // try navigator.clipboard first
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(cmd);
          showToast('Comando CURL copiato negli appunti.','success');
          return;
        }
      } catch (e) {
        // continue to fallback
      }
      // fallback using textarea
      try {
        const ta = document.createElement('textarea');
        ta.value = cmd; document.body.appendChild(ta); ta.select();
        document.execCommand('copy'); ta.remove();
        showToast('Comando CURL copiato negli appunti.','success');
      } catch (e) {
        showToast('Copia fallita. Copia manualmente il comando mostrato.', 'error');
        // show the command in a prompt as last resort
        window.prompt('Copia questo comando CURL:', cmd);
      }
    }

    // Checkout
    async function checkout() {
      if (cart.length === 0) {
        showToast('Aggiungi prodotti al carrello prima di ordinare.','error');
        return;
      }

      const user_contatto = document.getElementById('user_contatto').value;
      const user_nome = document.getElementById('user_nome').value || 'Cliente Anonimo';
      const indirizzo = document.getElementById('indirizzo').value;
      const citofono = document.getElementById('citofono').value || '';
      const note = document.getElementById('note').value || '';

      if (!user_contatto || !indirizzo) {
        showToast('Compila tutti i campi obbligatori.','error');
        return;
      }

      const orderData = {
        prodotti: cart.map(item => ({ id: item.id, nome: item.nome, qty: item.qty, magazzino: item.magazzino || 1 })),
        user_contatto,
        user_nome,
        indirizzo,
        citofono,
        note
      };

      try {
        const response = await fetch(`${API_BASE}/privato/ordina.py`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-API-KEY': '4bba4221d47af247e69110d4d86335051ee13ea0795386341386f6af989f5ff2'
          },
          body: JSON.stringify(orderData)
        });

        const result = await response.json();

        if (response.ok && result.ordine) {
          const okMsg = `‚úÖ Ordine creato con successo! ID: ${result.ordine} üì± Riceverai aggiornamenti via Telegram.`;
          document.getElementById('ordine-ok').textContent = okMsg;
          document.getElementById('ordine-ok').style.display = 'block';
          showToast(okMsg,'success');
          // Reset
          document.getElementById('user_contatto').value = '';
          document.getElementById('user_nome').value = '';
          document.getElementById('indirizzo').value = '';
          document.getElementById('citofono').value = '';
          document.getElementById('note').value = '';
          selectedProduct = null;
          cart = [];
          updateCartBadge();
          updateCartDisplay();
          loadProducts();
        } else {
          showToast(`‚ùå Errore ordine: ${result.error || 'Errore sconosciuto'}`,'error');
        }
      } catch (error) {
        console.error('Errore ordine:', error);
        showToast('‚ùå Errore di connessione. Riprova tra qualche istante.','error');
      }
    }

    // Carica prodotti al caricamento pagina
    loadProducts();
  </script>
</body>
</html>
