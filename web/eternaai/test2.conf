flush ruleset

#
# ==================================
# == Tabella IPv4 - Filtro Pacchetti ==
# ==================================
#
table ip filter {
    # Set per IP bannati da Fail2Ban (verranno riempiti automaticamente)
    set f2b-sshd {
        type ipv4_addr
        flags dynamic
    }
    set f2b-HONEYPOT-SCAN {
        type ipv4_addr
        flags dynamic
    }
    set f2b-apache-badbots {
        type ipv4_addr
        flags dynamic
    }

    # Catena principale per il traffico in ingresso
    chain INPUT {
        type filter hook input priority filter; policy accept;

        # Regole base: accetta loopback e connessioni gi√† attive
        iif "lo" accept
        ct state established,related accept

        # Accetta traffico dalla rete ZeroTier (era nel tuo vecchio backup)
        iifname "zt3jnzctjb" accept

        # Controlla gli IP bannati da Fail2Ban
    ip saddr @f2b-sshd tcp dport { 2223, 36211 } reject
        ip saddr @f2b-HONEYPOT-SCAN tcp dport 7070 reject
        ip saddr @f2b-apache-badbots tcp dport { 80, 443 } reject

        # NOTA DI SICUREZZA:
        # L'accesso SSH a questa macchina DEVE essere consentito esclusivamente tramite:
        #   1. La rete ZeroTier (interfaccia "zt3jnzctjb")
        #   2. La VPN WireGuard (interfaccia "wg0")
        #   3. Il tuo IP privato statico (193.148.18.52)
        # Tutte le altre connessioni SSH devono essere bloccate.
        # L'autenticazione SSH deve avvenire SOLO tramite chiave pubblica, mai tramite password!

        # Accetta SSH solo da ZeroTier, dal tuo IP privato e dalla VPN WireGuard
    iifname "zt3jnzctjb" tcp dport 2223 accept
    iifname "wg0" tcp dport 2223 accept
    ip saddr 193.148.18.52 tcp dport 2223 accept  # <-- il tuo IP privato, se serve
    ip saddr 93.57.240.131 tcp dport 2223 accept  # <-- aggiunto per richiesta

    # Blocca tutto il resto su 2223
    tcp dport 2223 drop

        # Porte TCP aperte (escludi 2222!)
    tcp dport { 80, 443, 501, 587, 993, 2525, 2626, 1024, 5000, 5003, 5432, 6666, 8000, 8001, 8002, 8080, 8181, 8282, 8383, 8484, 8585, 8686, 8787, 8989, 9001, 9040, 9050, 12345, 29544, 29545, 7099, 8110, 33445 } accept


        # Porte UDP aperte
        udp dport { 5353, 51820, 29544, } accept

        # --- AGGIUNGI QUI ---
        tcp dport 2627 accept
        udp dport 2627 accept
        # --- FINE AGGIUNTA ---

        # Regola specifica per Honeypot con logging
        tcp dport 7070 log prefix "HONEYPOT-7070 " accept

    # Regola specifica per IP
    ip saddr 193.148.18.52 tcp dport 2223 accept

        # IP bloccati manualmente
        ip saddr { 117.231.177.169, 45.135.193.100, 139.59.118.225, 160.238.156.6 } drop
    }

    # Catena per il traffico in uscita
    chain OUTPUT {
        type filter hook output priority filter; policy accept;
    }

    # Catena per il forwarding (necessaria per Docker e VPN)
    chain FORWARD {
        type filter hook forward priority filter; policy accept;
        # Regole Docker
        iifname "docker0" oifname != "docker0" accept
        iifname "docker0" oifname "docker0" accept
        oifname "docker0" ct state established,related accept
        # Regole WireGuard
        iifname "wg0" oifname "wlan0" accept
        iifname "wlan0" oifname "wg0" ct state established,related accept
        iifname "wg0" accept
        oifname "wg0" ct state established,related accept
    }
}

# ==================================
# == Tabella IPv4 - MANGLE (mark pacchetti VPN) ==
# ==================================

table ip mangle {
    chain PREROUTING {
        type filter hook prerouting priority mangle; policy accept;
        # Marca i pacchetti in ingresso dalla VPN per instradarli verso Tor
        iifname "wg0" counter meta mark set 1
    }
}

#
# ==================================
# == Tabella IPv4 - NAT (Docker/VPN) ==
# ==================================
#
table ip nat {
    chain PREROUTING {
        type nat hook prerouting priority dstnat; policy accept;
        # Redireziona il traffico dalla VPN
        iifname "wg0" tcp flags syn redirect to :9040
        ip saddr 10.10.0.0/24 udp dport 53 redirect to :5353
    }

    chain OUTPUT {
        type nat hook output priority 0; policy accept;
        # Redireziona il traffico uscente sulla VPN
        oifname "wg0" ip protocol tcp redirect to :9050
        oifname "wg0" udp dport 53 redirect to :5353
        oifname "wg0" tcp flags syn redirect to :9040
        ip saddr 10.10.0.0/24 tcp dport { 80, 443 } redirect to :9040
    }

    chain POSTROUTING {
        type nat hook postrouting priority srcnat; policy accept;
        # Masquerade per Docker
        ip saddr 172.17.0.0/16 oifname != "docker0" masquerade
        # Masquerade per la VPN
        ip saddr 10.10.0.0/24 oifname { "wlan0", "wlp5s0" } masquerade
        oifname "wlan0" masquerade
    }
}

#
# ==================================
# == Tabella IPv6 - Filtro Pacchetti ==
# ==================================
#
table ip6 filter {
    chain input {
        type filter hook input priority 0; policy drop;

        # üîì SSH mirato
        ip6 daddr 200:421e:6385:4a8b:dca7:cfb:197f:e9c3 tcp dport 8022 accept

        # üîì Apri API FastAPI/YGG prima del drop (valido per tutti)
        tcp dport { 9725, 55557 } accept

        # ‚úã Drop tutto ci√≤ che entra su Ygg non da ygg0/tun0
        iifname != { "ygg0", "tun0" } ip6 daddr 200::/7 drop

        # üéØ Accetta loopback e connessioni stabilite
        iif "lo" accept
        ct state established,related accept
        ip6 nexthdr icmpv6 accept
    }

    chain output {
        type filter hook output priority 0; policy accept;
        # Permetti traffico Yggdrasil solo dall'interfaccia Yggdrasil
        ip6 saddr 200::/7 oifname != "ygg0" drop
    }

    chain FORWARD {
        type filter hook forward priority 0; policy drop;
    }
}

# Tabella mangle per marking VPN
table ip mangle {
    chain PREROUTING {
        type filter hook prerouting priority mangle; policy accept;
    iifname wg0 counter meta mark set 1
    }
}

# Mitigazione leak IPv6 per VPN
table ip6 filter {
    chain FORWARD {
        type filter hook forward priority 0; policy drop;
    iifname wg0 counter drop
    }
    chain OUTPUT {
        type filter hook output priority 0; policy accept;
    # ip6 saddr 10.10.0.0/24 counter drop
    }
}
