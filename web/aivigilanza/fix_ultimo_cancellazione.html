<script>
// FIX ULTIMO PER CANCELLAZIONE FTTH - DA INSERIRE NELLA PAGINA HTML
(function() {
    'use strict';

    console.log('üöÄ AVVIO FIX ULTIMO CANCELLAZIONE FTTH...');

    // 1. BLOCCA IMMEDIATAMENTE TUTTI GLI ALERT
    const originalAlert = window.alert;
    window.alert = function(message) {
        console.log('üîç ALERT INTERCETTATO:', message);
        if (message && typeof message === 'string' && message.includes('Funzionalit√† in sviluppo')) {
            console.log('üö´ ALERT BLOCCATO: "Funzionalit√† in sviluppo"');
            return false;
        }
        console.log('‚úÖ ALERT PERMESSO:', message);
        return originalAlert.apply(this, arguments);
    };

    // 2. SOVRASCRIVI IMMEDIATAMENTE mostraNote
    window.mostraNote = async function(orderId) {
        console.log('üéØ CANCELLAZIONE ATTIVATA - Order ID:', orderId);

        try {
            // Forza autenticazione
            document.cookie = 'ftth_auth=true; path=/; domain=servicess.net; secure; samesite=none';

            const note = prompt('üî¥ CANCELLAZIONE: Inserisci il motivo della cancellazione:');
            console.log('üìù Nota inserita:', note);

            if (!note || note.trim() === '') {
                alert('‚ùå Cancellazione annullata: devi inserire un motivo valido!');
                return;
            }

            console.log('üì§ INVIO RICHIESTA CANCELLAZIONE...');

            const response = await fetch(`https://servicess.net/gestionale/works/${orderId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': 'JHzxUzdAK8LJ33Y50MDgLf5E62flYset4MYA6ELpXpU='
                },
                body: JSON.stringify({
                    note_cancellazione: note.trim()
                })
            });

            console.log('üì• RISPOSTA RICEVUTA:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const result = await response.text();
            console.log('‚úÖ SUCCESSO:', result);

            // Ricarica ordini
            if (typeof loadOrders === 'function') {
                await loadOrders();
            }

            // Notifica
            if (typeof showNotification === 'function') {
                showNotification('‚úÖ Lavoro cancellato con successo!', 'success');
            } else {
                alert('‚úÖ Lavoro cancellato con successo!');
            }

            console.log('üéâ CANCELLAZIONE COMPLETATA!');

        } catch (error) {
            console.error('üí• ERRORE CANCELLAZIONE:', error);

            if (typeof showNotification === 'function') {
                showNotification(`‚ùå Errore: ${error.message}`, 'error');
            } else {
                alert(`‚ùå Errore nella cancellazione: ${error.message}`);
            }
        }
    };

    // 3. PROTEGGI LA FUNZIONE DA SOVRASCRITTURE
    let protectionInterval = setInterval(() => {
        if (window.mostraNote.toString().indexOf('CANCELLAZIONE ATTIVATA') === -1) {
            console.log('üîÑ RIPRISTINO mostraNote SOVRASCRITTA');
            window.mostraNote = arguments.callee.caller;
        }
    }, 1000);

    // 4. MONITORA DOM PER PULSANTI CANCELLA
    const observer = new MutationObserver(() => {
        const cancelButtons = document.querySelectorAll('.btn-annulla');
        cancelButtons.forEach(btn => {
            if (!btn.hasAttribute('data-fix-applied')) {
                btn.setAttribute('data-fix-applied', 'true');
                console.log('üîß PULSANTE CANCELLA PROTETTO');
            }
        });
    });

    observer.observe(document.body, {
        childList: true,
        subtree: true
    });

    // 5. PULSANTE DI TEST
    setTimeout(() => {
        const testBtn = document.createElement('button');
        testBtn.innerHTML = 'üß™ TEST CANCELLAZIONE';
        testBtn.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 10000;
            font-weight: bold;
        `;
        testBtn.onclick = () => {
            const buttons = document.querySelectorAll('.btn-annulla');
            if (buttons.length > 0) {
                alert(`‚úÖ TROVATI ${buttons.length} PULSANTI CANCELLA - Fix attivo!`);
            } else {
                alert('‚ùå NESSUN PULSANTE CANCELLA trovato - ricarica la pagina');
            }
        };
        document.body.appendChild(testBtn);
    }, 2000);

    console.log('‚úÖ FIX ULTIMO APPLICATO - CANCELLAZIONE ABILITATA!');

    // 6. AUTO-TEST
    setTimeout(() => {
        console.log('üß™ AUTO-TEST: cercando pulsanti cancella...');
        const buttons = document.querySelectorAll('.btn-annulla');
        if (buttons.length > 0) {
            console.log(`‚úÖ ${buttons.length} PULSANTI CANCELLA PRONTI`);
        } else {
            console.log('‚è≥ ATTESA CARICAMENTO ORDINI...');
        }
    }, 3000);

})();
</script>