<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DB Viewer - Debug</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center">
  <h1>DB Viewer <small id="staticVersion" class="text-muted ms-2"></small> <small id="apiStatusBadge" class="text-muted ms-2"></small></h1>
      <a href="/fibra/index.html" class="btn btn-outline-secondary">Torna</a>
    </div>
    <p class="text-muted">Questa pagina è riservata ad amministratori; è richiesta autenticazione (X-API-Key o Bearer token).</p>
  <div class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label">Table</label>
        <select id="tableSelect" class="form-select">
          <option value="works">works</option>
          <option value="technicians">technicians</option>
          <option value="teams">teams</option>
          <option value="documents">documents</option>
          <option value="work_events">work_events</option>
          <option value="document_applied_works">document_applied_works</option>
          <option value="users">users</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Limit</label>
        <input id="limit" class="form-control" type="number" value="100" />
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <div style="flex: 1">
          <label class="form-label">Authorization (opzionale)</label>
          <input id="jwt_token" type="password" class="form-control" placeholder="JWT Bearer token (opzionale)" />
        </div>
        <div style="margin-left: 0.5rem; margin-bottom: 0.5rem;">
          <button id="toggleJwtBtn" type="button" class="btn btn-outline-secondary btn-sm">Mostra</button>
        </div>
        <div style="margin-left: 0.5rem; margin-bottom: 0.5rem;">
          <button id="toggleForceDirectBtn" type="button" class="btn btn-outline-danger btn-sm" style="display:none">Forza backend locale</button>
        </div>
      </div>
      <div class="col-md-3">
        <button id="loadBtn" class="btn btn-primary">Carica</button>
      </div>
    </div>
  <div class="mt-2 small text-muted">Incolla solo un JWT valido (es. <code>il-tuo-jwt</code>). L'X-API-Key, se configurata sul server, è fornita automaticamente.</div>
  <div id="targetUrl" class="mt-2 small text-muted"></div>
  <div id="resultSummary" class="mt-1 small text-muted"></div>
    <div class="mt-3"><pre id="outArea" style="max-height:60vh;overflow:auto;background:#f8f9fa;padding:10px;border:1px solid #ddd"></pre></div>
  </div>
  <script>
    try { document.getElementById('staticVersion').textContent = 'deploy: ' + new Date().toISOString(); } catch(e) {}
    
    // API Configuration - usa proxy Apache a Yggdrasil
    var API = '/gestionale';
    
    // Allow a developer override via sessionStorage or an explicit window.__API_BASE__.
    const _forceDirect = sessionStorage.getItem('FORCE_DIRECT_API') === 'true';
    if (_forceDirect && window.__API_BASE__) {
      API = window.__API_BASE__;
    }
    
    // Small helper to toggle dev override for local testing
    function toggleForceDirectApi() {
        if (!['localhost', '127.0.0.1', '::1'].includes(window.location.hostname)) return;
      const cur = sessionStorage.getItem('FORCE_DIRECT_API');
      if (cur === 'true') sessionStorage.removeItem('FORCE_DIRECT_API');
      else sessionStorage.setItem('FORCE_DIRECT_API', 'true');
      location.reload();
    }
    
    try { document.getElementById('apiStatusBadge').textContent = 'API: ' + (API ? API : 'same-origin (via proxy)'); } catch(e) {}
    
    document.getElementById('loadBtn').addEventListener('click', async () => {
      const table = document.getElementById('tableSelect').value;
      const limit = document.getElementById('limit').value || 100;
      let jwtToken = document.getElementById('jwt_token').value.trim();
      // We do not accept or use client-side API keys in the UI. Rely on JWT or server-side injection.
      const headers = {};
      // If user supplied a JWT, attach Authorization header
      if (jwtToken && jwtToken.toLowerCase().startsWith('bearer ')) {
        headers['Authorization'] = jwtToken;
      } else if (jwtToken && jwtToken.split('.').length === 3) {
        headers['Authorization'] = `Bearer ${jwtToken}`;
      }
      try {
        // For debugging, expose the target URL and request headers
        const url = (API || '') + `/debug/db?table=${encodeURIComponent(table)}&limit=${limit}`;
        // Display target API URL for debugging
        try { document.getElementById('targetUrl').textContent = 'Target API URL: ' + url; } catch (e) {}
        const resp = await fetch(url, { headers });
        const data = await resp.json();
        if (!resp.ok) {
          const err = data.detail || JSON.stringify(data);
          // Show additional details: attempted URL and headers to help diagnose wrong host/port
          const masked = maskHeaders(headers);
          // If authentication failed, give actionable debug steps for the public server
          if (resp.status === 401 || resp.status === 403) {
            let advice = '\nNOTE: X-API-Key is automatically injected by Apache proxy. Check server configuration if authentication fails.';
            document.getElementById('outArea').textContent = `Error: ${err}\nRequest URL: ${url}\nSent headers: ${JSON.stringify(masked)}${advice}`;
          } else {
            document.getElementById('outArea').textContent = `Error: ${err}\nRequest URL: ${url}\nSent headers: ${JSON.stringify(masked)}`;
          }
          return;
        }
        // Show a brief summary and sample rows to confirm DB was read
        try { document.getElementById('resultSummary').textContent = `Table: ${table} | Count: ${data.count}`; } catch (e) {}
        const sampleRows = (data.rows && data.rows.slice(0, 3)) || [];
        const masked = maskHeaders(headers);
        document.getElementById('outArea').textContent = JSON.stringify(sampleRows, null, 2) + '\n\nSent headers (masked): ' + JSON.stringify(masked);
      } catch (e) {
        document.getElementById('outArea').textContent = 'Network error: ' + e.message + '\nMake sure the API backend is reachable via proxy.\nTarget API URL: ' + (API || '/') ;
      }
    });
    
    // Toggle jwt visibility
    try {
      document.getElementById('toggleJwtBtn').addEventListener('click', function () {
        const inp = document.getElementById('jwt_token');
        if (inp.type === 'password') { inp.type = 'text'; this.textContent = 'Nascondi'; } else { inp.type = 'password'; this.textContent = 'Mostra'; }
      });
    } catch (e) {}
    
    try {
      const btn = document.getElementById('toggleForceDirectBtn');
      if (btn) {
        if (['localhost','127.0.0.1','::1'].includes(window.location.hostname)) {
          btn.style.display = 'inline-block';
          const updateLabel = () => {
            const forced = sessionStorage.getItem('FORCE_DIRECT_API') === 'true';
            btn.textContent = forced ? 'Disattiva backend locale' : 'Forza backend locale';
          };
          updateLabel();
          btn.addEventListener('click', () => {
            toggleForceDirectApi();
          });
        }
      }
    } catch (e) {}

    function maskValue(v) {
      if (!v) return v;
      if (v.length <= 6) return '****' + v.slice(-2);
      return v.slice(0, 3) + '...' + v.slice(-4);
    }
    function maskHeaders(headers) {
      const out = {};
      for (const k of Object.keys(headers || {})) {
        const v = headers[k] || '';
        if (k.toLowerCase() === 'x-api-key') { out[k] = maskValue(v); }
        else if (k.toLowerCase() === 'authorization') {
          const parts = v.split(' ');
          if (parts.length === 2 && parts[0].toLowerCase() === 'bearer') out[k] = parts[0] + ' ' + maskValue(parts[1]);
          else out[k] = maskValue(v);
        } else out[k] = v;
      }
      return out;
    }
  </script>
</body>
</html>
<script src="auth.js"></script>
