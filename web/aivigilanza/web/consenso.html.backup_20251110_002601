<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consenso Trattamento Dati - TorciaBook</title>
  <link rel="canonical" href="https://servicess.net/consenso.html" />
    <style>
        :root {
            --bg: #f8f9fa;
            --card: #ffffff;
            --text: #212529;
            --muted: #6c757d;
            --primary: #007bff;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --border: #dee2e6;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px 0;
        }

        .header h1 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: var(--muted);
            font-size: 1.1em;
        }

        .cookie-banner {
            background: var(--warning);
            color: #000;
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .cookie-banner a {
            color: #000;
            text-decoration: underline;
        }

        .form-card {
            background: var(--card);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 40px;
            margin-bottom: 30px;
        }

        .form-card h2 {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .checkbox-group {
            background: #f8f9ff;
            border: 1px solid var(--primary);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .checkbox-group label {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            cursor: pointer;
            font-weight: normal;
        }

        .checkbox-group input[type="checkbox"] {
            margin-top: 2px;
            width: auto;
        }

        .consenso-text {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-line;
        }

        .buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--muted);
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .message.success {
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .message.error {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .riepilogo {
            background: var(--card);
            border: 2px solid var(--success);
            border-radius: 12px;
            padding: 30px;
            margin-top: 30px;
            display: none;
        }

        .riepilogo h3 {
            color: var(--success);
            margin-bottom: 20px;
        }

        .riepilogo-item {
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .riepilogo-item:last-child {
            border-bottom: none;
        }

        .riepilogo-label {
            font-weight: bold;
            color: var(--muted);
        }

        .riepilogo-value {
            color: var(--text);
        }

        .auth-badge {
            background: var(--success);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            text-align: center;
            margin: 20px 0;
            font-weight: bold;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .required {
            color: var(--danger);
        }

        /* CAPTCHA Anti-Bot */
        .captcha-section {
            background: var(--card);
            border: 2px solid var(--warning);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .captcha-question {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--warning);
            margin-bottom: 15px;
        }

        .captcha-input {
            width: 100px;
            height: 50px;
            font-size: 1.5em;
            text-align: center;
            border: 2px solid var(--warning);
            border-radius: 8px;
            margin: 0 10px;
        }

        .captcha-refresh {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 0.9em;
        }

        .captcha-refresh:hover {
            background: var(--primary);
        }

        .captcha-error {
            color: var(--danger);
            margin-top: 10px;
            font-weight: bold;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: var(--muted);
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .form-card {
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                text-align: center;
            }

            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è Consenso Trattamento Dati</h1>
            <p>Sistema sicuro di registrazione consensi - TorciaBook</p>
        </div>

        <!-- Banner Cookie -->
        <div class="cookie-banner">
            üç™ Continuando accetti l'uso di cookie tecnici necessari per il funzionamento del sito.
            <a href="#privacy">Maggiori informazioni</a>
        </div>

        <!-- Form -->
        <form id="consensoForm" method="post">
            <div class="form-card">
                <h2>üìã Dati Personali</h2>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="nome">Nome <span class="required">*</span></label>
                        <input type="text" id="nome" name="nome" required>
                    </div>

                    <div class="form-group">
                        <label for="cognome">Cognome <span class="required">*</span></label>
                        <input type="text" id="cognome" name="cognome" required>
                    </div>

                    <div class="form-group">
                        <label for="indirizzo">Indirizzo <span class="required">*</span></label>
                        <input type="text" id="indirizzo" name="indirizzo" required placeholder="Via/Piazza, numero">
                    </div>

                    <div class="form-group">
                        <label for="cap">CAP <span class="required">*</span></label>
                        <input type="text" id="cap" name="cap" required pattern="[0-9]{5}" placeholder="12345">
                    </div>

                    <div class="form-group">
                        <label for="citta">Citt√† <span class="required">*</span></label>
                        <input type="text" id="citta" name="citta" required>
                    </div>

                    <div class="form-group">
                        <label for="provincia">Provincia <span class="required">*</span></label>
                        <select id="provincia" name="provincia" required>
                            <option value="">Seleziona provincia</option>
                            <option value="AG">Agrigento</option>
                            <option value="AL">Alessandria</option>
                            <option value="AN">Ancona</option>
                            <option value="AO">Aosta</option>
                            <option value="AR">Arezzo</option>
                            <option value="AP">Ascoli Piceno</option>
                            <option value="AT">Asti</option>
                            <option value="AV">Avellino</option>
                            <option value="BA">Bari</option>
                            <option value="BT">Barletta-Andria-Trani</option>
                            <option value="BL">Belluno</option>
                            <option value="BN">Benevento</option>
                            <option value="BG">Bergamo</option>
                            <option value="BI">Biella</option>
                            <option value="BO">Bologna</option>
                            <option value="BZ">Bolzano</option>
                            <option value="BS">Brescia</option>
                            <option value="BR">Brindisi</option>
                            <option value="CA">Cagliari</option>
                            <option value="CL">Caltanissetta</option>
                            <option value="CB">Campobasso</option>
                            <option value="CI">Carbonia-Iglesias</option>
                            <option value="CE">Caserta</option>
                            <option value="CT">Catania</option>
                            <option value="CZ">Catanzaro</option>
                            <option value="CH">Chieti</option>
                            <option value="CO">Como</option>
                            <option value="CS">Cosenza</option>
                            <option value="CR">Cremona</option>
                            <option value="KR">Crotone</option>
                            <option value="CN">Cuneo</option>
                            <option value="EN">Enna</option>
                            <option value="FM">Fermo</option>
                            <option value="FE">Ferrara</option>
                            <option value="FI">Firenze</option>
                            <option value="FG">Foggia</option>
                            <option value="FC">Forl√¨-Cesena</option>
                            <option value="FR">Frosinone</option>
                            <option value="GE">Genova</option>
                            <option value="GO">Gorizia</option>
                            <option value="GR">Grosseto</option>
                            <option value="IM">Imperia</option>
                            <option value="IS">Isernia</option>
                            <option value="SP">La Spezia</option>
                            <option value="AQ">L'Aquila</option>
                            <option value="LT">Latina</option>
                            <option value="LE">Lecce</option>
                            <option value="LC">Lecco</option>
                            <option value="LI">Livorno</option>
                            <option value="LO">Lodi</option>
                            <option value="LU">Lucca</option>
                            <option value="MC">Macerata</option>
                            <option value="MN">Mantova</option>
                            <option value="MS">Massa-Carrara</option>
                            <option value="MT">Matera</option>
                            <option value="ME">Messina</option>
                            <option value="MI">Milano</option>
                            <option value="MO">Modena</option>
                            <option value="MB">Monza e della Brianza</option>
                            <option value="NA">Napoli</option>
                            <option value="NO">Novara</option>
                            <option value="NU">Nuoro</option>
                            <option value="OT">Olbia-Tempio</option>
                            <option value="OR">Oristano</option>
                            <option value="PD">Padova</option>
                            <option value="PA">Palermo</option>
                            <option value="PR">Parma</option>
                            <option value="PV">Pavia</option>
                            <option value="PG">Perugia</option>
                            <option value="PU">Pesaro e Urbino</option>
                            <option value="PE">Pescara</option>
                            <option value="PC">Piacenza</option>
                            <option value="PI">Pisa</option>
                            <option value="PT">Pistoia</option>
                            <option value="PN">Pordenone</option>
                            <option value="PZ">Potenza</option>
                            <option value="PO">Prato</option>
                            <option value="RG">Ragusa</option>
                            <option value="RA">Ravenna</option>
                            <option value="RC">Reggio Calabria</option>
                            <option value="RE">Reggio Emilia</option>
                            <option value="RI">Rieti</option>
                            <option value="RN">Rimini</option>
                            <option value="RM">Roma</option>
                            <option value="RO">Rovigo</option>
                            <option value="SA">Salerno</option>
                            <option value="SS">Sassari</option>
                            <option value="SV">Savona</option>
                            <option value="SI">Siena</option>
                            <option value="SR">Siracusa</option>
                            <option value="SO">Sondrio</option>
                            <option value="TA">Taranto</option>
                            <option value="TE">Teramo</option>
                            <option value="TR">Terni</option>
                            <option value="TO">Torino</option>
                            <option value="TP">Trapani</option>
                            <option value="TN">Trento</option>
                            <option value="TV">Treviso</option>
                            <option value="TS">Trieste</option>
                            <option value="UD">Udine</option>
                            <option value="VA">Varese</option>
                            <option value="VE">Venezia</option>
                            <option value="VB">Verbano-Cusio-Ossola</option>
                            <option value="VC">Vercelli</option>
                            <option value="VR">Verona</option>
                            <option value="VV">Vibo Valentia</option>
                            <option value="VI">Vicenza</option>
                            <option value="VT">Viterbo</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="telefono">Telefono</label>
                        <input type="tel" id="telefono" name="telefono" placeholder="Opzionale">
                    </div>
                </div>
            </div>

            <!-- Consenso Privacy -->
            <div class="form-card">
                <h2>üîí Consenso al Trattamento dei Dati Personali</h2>

                <div class="checkbox-group">
                    <input type="checkbox" id="consenso_privacy" name="consenso_privacy" required>
                    <label for="consenso_privacy">
                        <strong>Accetto il trattamento dei dati personali</strong> <span class="required">*</span>
                    </label>
                </div>

                <div class="consenso-text" id="testo-consenso">
CONSENSO INFORMATO PER IL TRATTAMENTO DEI DATI PERSONALI

Ai sensi dell'art. 13 del Regolamento (UE) 2016/679 (GDPR), dichiaro di aver ricevuto
l'informativa sul trattamento dei dati personali e di prestare il mio consenso
esplicito, libero e informato al trattamento dei miei dati personali per le
finalit√† indicate nell'informativa stessa.

Il consenso √® revocabile in qualsiasi momento senza pregiudicare la liceit√†
del trattamento basato sul consenso prestato prima della revoca.

Dichiaro inoltre di accettare l'utilizzo di cookie tecnici necessari per il
funzionamento del sito web.
                </div>
            </div>

            <!-- Consenso Cookie -->
            <div class="form-card">
                <h2>üç™ Accettazione Cookie</h2>

                <div class="checkbox-group">
                    <input type="checkbox" id="consenso_cookie" name="consenso_cookie" required>
                    <label for="consenso_cookie">
                        <strong>Accetto l'utilizzo di cookie tecnici necessari</strong> <span class="required">*</span>
                    </label>
                </div>

                <p style="margin-top: 10px; font-size: 14px; color: var(--muted);">
                    I cookie tecnici sono essenziali per il funzionamento del sito e non richiedono consenso specifico.
                    <a href="#cookie-policy" style="color: var(--primary);">Maggiori informazioni</a>
                </p>
            </div>

            <!-- CAPTCHA Anti-Bot -->
            <div class="captcha-section">
                <h3>ü§ñ Verifica Anti-Bot</h3>
                <p>Per prevenire spam, risolvi questa semplice operazione matematica:</p>
                
                <div class="captcha-question" id="captcha-question">
                    Loading...
                </div>
                
                <div>
                    <input type="number" 
                           id="captcha-answer" 
                           class="captcha-input" 
                           placeholder="?" 
                           required 
                           min="0" 
                           max="999">
                    <button type="button" class="captcha-refresh" onclick="generateCaptcha()">
                        üîÑ Nuova Domanda
                    </button>
                </div>
                
                <div class="captcha-error" id="captcha-error" style="display: none;"></div>
            </div>

            <div class="message" id="message"></div>

            <div class="buttons">
                <button type="button" class="btn btn-secondary" onclick="window.history.back()">Annulla</button>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    üì§ Invia Consenso
                </button>
            </div>
        </form>

        <!-- Riepilogo (nascosto inizialmente) -->
        <div class="riepilogo" id="riepilogo">
            <h3>‚úÖ Consenso Registrato con Successo</h3>

            <div class="auth-badge" id="auth-badge">
                üîê Richiesta autenticata da IP <span id="ip-auth"></span> il <span id="timestamp-auth"></span>
            </div>

            <div id="riepilogo-content">
                <!-- Riempito via JavaScript -->
            </div>
        </div>

        <div class="footer">
            <p>¬© 2025 TorciaBook - Sistema di gestione consensi GDPR compliant</p>
            <p><a href="#privacy-policy">Privacy Policy</a> | <a href="#cookie-policy">Cookie Policy</a> | <a href="#termini">Termini e Condizioni</a></p>
        </div>
    </div>

    <script>
        // ===== CAPTCHA ANTI-BOT =====
        let currentCaptcha = {};

        function generateCaptcha() {
            // Genera due numeri casuali tra 1 e 50
            const num1 = Math.floor(Math.random() * 50) + 1;
            const num2 = Math.floor(Math.random() * 50) + 1;
            
            // Scegli operazione casuale (+, -, *)
            const operations = ['+', '-', '*'];
            const operation = operations[Math.floor(Math.random() * operations.length)];
            
            let answer;
            switch(operation) {
                case '+':
                    answer = num1 + num2;
                    break;
                case '-':
                    // Assicurati che il risultato sia positivo
                    if (num1 < num2) {
                        answer = num2 - num1;
                        currentCaptcha = { num1: num2, num2: num1, operation, answer };
                    } else {
                        answer = num1 - num2;
                        currentCaptcha = { num1, num2, operation, answer };
                    }
                    break;
                case '*':
                    // Usa numeri pi√π piccoli per moltiplicazione
                    const smallNum1 = Math.floor(Math.random() * 12) + 1;
                    const smallNum2 = Math.floor(Math.random() * 12) + 1;
                    answer = smallNum1 * smallNum2;
                    currentCaptcha = { num1: smallNum1, num2: smallNum2, operation, answer };
                    break;
            }
            
            if (operation !== '*') {
                currentCaptcha = { num1: currentCaptcha.num1 || num1, num2: currentCaptcha.num2 || num2, operation, answer };
            }
            
            // Mostra la domanda
            document.getElementById('captcha-question').textContent = 
                `Quanto fa ${currentCaptcha.num1} ${operation} ${currentCaptcha.num2} ?`;
            
            // Pulisci input e errori
            document.getElementById('captcha-answer').value = '';
            document.getElementById('captcha-error').style.display = 'none';
            
            console.log('CAPTCHA generato:', currentCaptcha); // Debug
        }

        function validateCaptcha() {
            const userAnswer = parseInt(document.getElementById('captcha-answer').value);
            const errorDiv = document.getElementById('captcha-error');
            
            if (isNaN(userAnswer)) {
                errorDiv.textContent = '‚ùå Inserisci un numero valido';
                errorDiv.style.display = 'block';
                return false;
            }
            
            if (userAnswer !== currentCaptcha.answer) {
                errorDiv.textContent = `‚ùå Risposta errata! La risposta corretta era ${currentCaptcha.answer}`;
                errorDiv.style.display = 'block';
                generateCaptcha(); // Genera nuovo CAPTCHA
                return false;
            }
            
            errorDiv.style.display = 'none';
            return true;
        }

        // Genera CAPTCHA al caricamento della pagina
        window.addEventListener('load', function() {
            generateCaptcha();
        });
        // ===== FINE CAPTCHA =====

        let clientIP = '';

        // Ottieni IP del client all'avvio
        async function getClientIP() {
            try {
                const response = await fetch('/api/ip');
                const data = await response.json();
                clientIP = data.ip;
                console.log('IP rilevato:', clientIP);
            } catch (error) {
                console.error('Errore nel rilevamento IP:', error);
            }
        }

        // Inizializza
        document.addEventListener('DOMContentLoaded', function() {
            getClientIP();
        });

        // Gestione form
        document.getElementById('consensoForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // ===== VALIDAZIONE CAPTCHA =====
            if (!validateCaptcha()) {
                return; // Blocca l'invio se CAPTCHA √® sbagliato
            }
            // ===== FINE VALIDAZIONE CAPTCHA =====

            const submitBtn = document.getElementById('submitBtn');
            const messageDiv = document.getElementById('message');
            const riepilogoDiv = document.getElementById('riepilogo');

            // Mostra loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="loading"></div>Registrazione in corso...';
            messageDiv.style.display = 'none';
            riepilogoDiv.style.display = 'none';

            try {
                // Raccogli i dati del form
                const formData = new FormData(this);
                
                // Aggiungi dati CAPTCHA per validazione server-side
                formData.append('captcha_question', `${currentCaptcha.num1} ${currentCaptcha.operation} ${currentCaptcha.num2}`);
                formData.append('captcha_answer', document.getElementById('captcha-answer').value);
                formData.append('captcha_expected', currentCaptcha.answer);

                // Invia i dati al backend
                const response = await fetch('/invia-consenso', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.detail || 'Errore durante l\'invio');
                }

                // Successo - mostra riepilogo
                messageDiv.className = 'message success';
                messageDiv.textContent = result.messaggio;
                messageDiv.style.display = 'block';

                // Popola riepilogo
                const riepilogo = result.riepilogo;
                document.getElementById('ip-auth').textContent = riepilogo.ip_autenticazione;
                document.getElementById('timestamp-auth').textContent = riepilogo.timestamp;

                const riepilogoContent = document.getElementById('riepilogo-content');
                riepilogoContent.innerHTML = `
                    <div class="riepilogo-item">
                        <span class="riepilogo-label">ID Consenso:</span>
                        <span class="riepilogo-value">${riepilogo.id}</span>
                    </div>
                    <div class="riepilogo-item">
                        <span class="riepilogo-label">Nome completo:</span>
                        <span class="riepilogo-value">${riepilogo.nome_completo}</span>
                    </div>
                    <div class="riepilogo-item">
                        <span class="riepilogo-label">Indirizzo:</span>
                        <span class="riepilogo-value">${riepilogo.indirizzo_completo}</span>
                    </div>
                    <div class="riepilogo-item">
                        <span class="riepilogo-label">Telefono:</span>
                        <span class="riepilogo-value">${riepilogo.telefono}</span>
                    </div>
                    <div class="riepilogo-item">
                        <span class="riepilogo-label">Hash consenso:</span>
                        <span class="riepilogo-value">${riepilogo.hash_consenso}</span>
                    </div>
                `;

                riepilogoDiv.style.display = 'block';

                submitBtn.innerHTML = '‚úÖ Registrato!';
                submitBtn.disabled = true;

                // Scroll al riepilogo
                riepilogoDiv.scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error('Errore:', error);
                messageDiv.className = 'message error';
                messageDiv.textContent = `‚ùå Errore: ${error.message}`;
                messageDiv.style.display = 'block';

                submitBtn.disabled = false;
                submitBtn.innerHTML = 'üì§ Riprova';
            }
        });

        // Validazione in tempo reale
        document.querySelectorAll('input[required], select[required]').forEach(field => {
            field.addEventListener('blur', function() {
                if (this.value.trim() === '') {
                    this.style.borderColor = 'var(--danger)';
                } else {
                    this.style.borderColor = 'var(--primary)';
                }
            });
        });

        // Validazione CAP
        document.getElementById('cap').addEventListener('input', function() {
            const cap = this.value.replace(/\D/g, '');
            this.value = cap;
            if (cap.length !== 5) {
                this.style.borderColor = 'var(--danger)';
            } else {
                this.style.borderColor = 'var(--primary)';
            }
        });
    </script>
</body>
</html>
